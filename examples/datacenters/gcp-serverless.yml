variables:
  gcpAccount:
    type: arcctlAccount
    description: Name of your registered GCP account.
    provider: gcp
  region:
    type: region
    description: Region to put resources in
    arcctlAccount: ${{ variables.gcpAccount }}
  dnsZone:
    type: string
    description: DNS name for DNS records (ex. architest.dev). The DNS zone must already exist within GCP.

resources:
  vpc:
    type: vpc
    name: ${{ datacenter.name }}-dc
    account: ${{ variables.gcpAccount }}
    region: ${{ variables.region }}

environment:
  hooks:
    - when:
        type: service
      namespace: ${{ environment.name }}
      labels:
        region: ${{ variables.region }}
        vpc: ${{ resources.vpc.name }}
    - when:
        type: deployment
      namespace: ${{ environment.name }}
      labels:
        region: ${{ variables.region }}
        vpc: ${{ resources.vpc.name }}
    - when:
        type: ingressRule
      resources:
        dnsRecord:
          type: dnsRecord
          account: ${{ variables.gcpAccount }}
          dnsZone: ${{ variables.dnsZone }}
          subdomain: ${{ this.inputs.subdomain }}
          recordType: A
          content: ${{ this.outputs.loadBalancerHostname }}
      dnsZone: ${{ variables.dnsZone }}
      vpc: ${{ resources.vpc.name }}
      region: ${{ variables.region }}
      namespace: ${{ environment.name }}
    - when:
        type: database
        databaseType: postgres
      resources:
        db-cluster:
          type: databaseCluster
          account: ${{ variables.gcpAccount }}
          name: ${{ environment.name }}-${{ this.name }}
          databaseSize: db-f1-micro
          databaseType: ${{ this.inputs.databaseType }}
          databaseVersion: ${{ this.inputs.databaseVersion }}
          region: ${{ variables.region }}
          vpc: ${{ resources.vpc.name }}
      databaseCluster: ${{ this.resources.db-cluster.id }}
      account: ${{ variables.gcpAccount }}
    # Rules for deploying smtp4dev to GCE instead of CloudRun
    - when:
        type: deployment
        image: rnwood/smtp4dev:v3
      strategy: gce
    # Note: component name was hardcoded here, can't target deployment name as defined in component yaml because we change it
    - when:
        type: service
        target_deployment: tyleraldrich/smtp4dev
      strategy: gce
    - when:
        type: ingressRule
        name: tyleraldrich/smtp4dev/smtp-http
      strategy: gce
    - account: ${{ variables.gcpAccount }}
      namespace: ${{ environment.name }}
