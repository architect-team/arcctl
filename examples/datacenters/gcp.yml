variables:
  region:
    type: region
    description: Region to put resources in
    arcctlAccount: ${{ variables.gcpAccount }}
  gcpAccount:
    description: Name of your registered GCP account.
    type: arcctlAccount
    provider: gcp
  dnsZone:
    type: string
    description: Name of DNS zone for DNS records

resources:
  vpc:
    type: vpc
    name: ${{ datacenter.name }}-dc-vpc
    account: ${{ variables.gcpAccount }}
    region: ${{ variables.region }}
  cluster:
    type: kubernetesCluster
    account: ${{ variables.gcpAccount }}
    name: ${{ datacenter.name }}-dc-cluster
    kubernetesVersion: 1.27.3-gke.1700
    region: ${{ variables.region }}
    vpc: ${{ resources.vpc.id }}
    nodePools:
      - name: pool1
        count: 1
        nodeSize: e2-medium

accounts:
  cluster:
    name: ${{ datacenter.name }}-dc-cluster
    provider: kubernetes
    credentials:
      # TODO: Project name is hardcoded
      # refreshCommand: gcloud container clusters get-credentials ${{ datacenter.name}}-dc-cluster --zone ${{ variables.region }} --project permanent-environment-testing
      configPath: ${{ resources.cluster.configPath }}

environment:
  resources:
    namespace:
      type: namespace
      account: ${{ accounts.cluster.id }}
      name: ${{ environment.name }}
    nginx-ingress-controller:
      type: helmChart
      name: ${{ environment.name }}-ingress-nginx
      account: ${{ accounts.cluster.id }}
      namespace: ${{ environment.resources.namespace.id }}
      repository: https://kubernetes.github.io/ingress-nginx
      chart: ingress-nginx
    zone:
      type: dnsZone
      account: ${{ variables.gcpAccount }}
      name: ${{ variables.dnsZone }}

  hooks:
    - when:
        type: secret
      account: ${{ variables.gcpAccount }}
    - when:
        type: database
        databaseType: postgres
      resources:
        db-cluster:
          type: databaseCluster
          account: ${{ variables.gcpAccount }}
          name: ${{ environment.name }}-${{ this.name }}
          databaseSize: db-f1-micro
          databaseType: ${{ this.inputs.databaseType }}
          databaseVersion: ${{ this.inputs.databaseVersion }}
          region: ${{ variables.region }}
          vpc: ${{ resources.vpc.name }}
      databaseCluster: ${{ this.resources.db-cluster.id }}
      account: ${{ variables.gcpAccount }}
    - when:
        type: ingressRule
      resources:
        dnsRecord:
          type: dnsRecord
          account: ${{ variables.gcpAccount }}
          dnsZone: ${{ environment.resources.zone.id }}
          subdomain: ${{ this.inputs.subdomain }}
          recordType: A
          content: ${{ this.outputs.loadBalancerHostname }}
      registry: nginx
      namespace: ${{ environment.resources.namespace.id }}
      dnsZone: ${{ variables.dnsZone }}
    - account: ${{ accounts.cluster.id }}
      namespace: ${{ environment.resources.namespace.id }}
