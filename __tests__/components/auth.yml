version: v2

databases:
  kratos:
    type: postgres:15
    migrate:
      image: oryd/kratos:v0.13.0
      entrypoint: [""]
      command:
        - sh
        - -c
        - kratos -c ./kratos/.kratos.yml migrate sql -e --yes
      environment:
        DSN: ${{ databases.kratos.url }}?max_conns=20&max_idle_conns=4

deployments:
  mailslurper:
    image: oryd/mailslurper:latest-smtps
    volumes:
      source:
        mount_path: /volume_test
        host_path: /home/muesch/Architect/code/arcctl/bin

  kratos:
    image: oryd/kratos:v0.13.0
    entrypoint: [""]
    command:
      - sh
      - -c
      - |
        mkdir ./kratos
        echo "$IDENTITY_SCHEMA" > ./kratos/identity.schema.json
        echo "$CONFIG" > ./kratos/.kratos.yml
        kratos -c ./kratos/.kratos.yml migrate sql -e --yes
        kratos serve -c ./kratos/.kratos.yml --watch-courier
    environment:
      CONFIG: |
        version: v0.13.0
        dsn: ${{ databases.kratos.url }}?max_conns=20&max_idle_conns=4
        serve:
          public:
            base_url: ${{ ingresses.public.url }}
            cors:
              enabled: true
          admin:
            base_url: ${{ services.admin.url }}
        selfservice:
          default_browser_return_url: ${{ ingresses.frontend.url }}
          allowed_return_urls:
            - ${{ ingresses.frontend.url }}
          methods:
            password:
              enabled: true
            totp:
              config:
                issuer: Kratos
              enabled: true
            code:
              enabled: true
            link:
              enabled: true
            lookup_secret:
              enabled: true
          flows:
            error:
              ui_url: ${{ ingresses.frontend.url }}error
            settings:
              ui_url: ${{ ingresses.frontend.url }}settings
              privileged_session_max_age: 15m
              required_aal: highest_available
            logout:
              after:
                default_browser_return_url: ${{ ingresses.frontend.url }}login
            login:
              ui_url: ${{ ingresses.frontend.url }}login
              lifespan: 10m
            registration:
              ui_url: ${{ ingresses.frontend.url }}registration
              lifespan: 10m
              after:
                password:
                  hooks:
                    - hook: session
                    - hook: show_verification_ui
            verification:
              enabled: true
              ui_url: ${{ ingresses.frontend.url }}verification
              use: code
              after:
                default_browser_return_url: ${{ ingresses.frontend.url }}
            recovery:
              enabled: true
              ui_url: ${{ ingresses.frontend.url }}recovery
              use: code
        courier:
          smtp:
            connection_uri: smtps://test:test@${{ services.smtps.host }}:${{ services.smtps.port }}/?skip_ssl_verify=true
        log:
          level: debug
          format: text
          leak_sensitive_values: true
        secrets:
          cookie:
            - PLEASE-CHANGE-ME-I-AM-VERY-INSECURE
          cipher:
            - 32-LONG-SECRET-NOT-SECURE-AT-ALL

        ciphers:
          algorithm: xchacha20-poly1305

        hashers:
          algorithm: bcrypt
          bcrypt:
            cost: 8
        identity:
          default_schema_id: default
          schemas:
            - id: default
              url: file://./kratos/identity.schema.json
        session:
          cookie:
            domain: davidthor.me
      IDENTITY_SCHEMA: |
        {
          "$id": "https://schemas.ory.sh/presets/kratos/quickstart/email-password/identity.schema.json",
          "$schema": "http://json-schema.org/draft-07/schema#",
          "title": "Person",
          "type": "object",
          "properties": {
            "traits": {
              "type": "object",
              "properties": {
                "email": {
                  "type": "string",
                  "format": "email",
                  "title": "E-Mail",
                  "minLength": 3,
                  "ory.sh/kratos": {
                    "credentials": {
                      "password": {
                        "identifier": true
                      }
                    },
                    "verification": {
                      "via": "email"
                    },
                    "recovery": {
                      "via": "email"
                    }
                  }
                },
                "name": {
                  "type": "object",
                  "properties": {
                    "first": {
                      "title": "First Name",
                      "type": "string"
                    },
                    "last": {
                      "title": "Last Name",
                      "type": "string"
                    }
                  }
                }
              },
              "required": [
                "email"
              ],
              "additionalProperties": false
            }
          }
        }

  ui:
    image: oryd/kratos-selfservice-ui-node:v0.13.0
    environment:
      PORT: '4455'
      KRATOS_PUBLIC_URL: ${{ services.public.url }}
      KRATOS_BROWSER_URL: ${{ ingresses.public.url }}
      LOG_LEVEL: debug
      LOG_FORMAT: text

services:
  smtp:
    deployment: mailslurper
    port: 4436
  smtps:
    deployment: mailslurper
    port: 4437
  public:
    deployment: kratos
    port: 4433
  admin:
    deployment: kratos
    port: 4434
  frontend:
    deployment: ui
    port: 4455

ingresses:
  public:
    service: public
  frontend:
    service: frontend
